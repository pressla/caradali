//m2m-socket-pipe.js
//Alex Pressl for imitrix GmbH
//use:
// var m2m = require('m2m-socket-pipe');
// createLogger ('0815:666');
// m2mlog ('lightcontrol', 'cmd', {cmd:'Lamp 100%', err:'no answer'});

// will send following socket cluster post to channel 'lightcontrol':
/*
[
  {
    "timestamp": "1427496743000",
    "node_id": "0815:666",
    "content": "cmd"
  },
  {
    "cmd": "Lamp 100%",
    "err": "no answer"
   }
]
*/


var scClient 	= require('socketcluster-client');

var options = {
  protocol: 'http',
  hostname: 'acc.ledwifi.de',
  port: 8051,
  autoReconnect: true
};
 
var socket = scClient.connect(options);
 
var deviceID	= 'nobody';

module.exports = createLogger = function  (devID) {
	deviceID = devID;
}

module.exports = m2mlog = function(channelname, messagename, payload){
  var header    = {};
  var prot    = [2];

	header.timestamp 	= (new Date()).getTime();
	header.node_id 		= deviceID;
	header.content 		= messagename;

	prot[0] = header;
	prot[1] = payload;
	try {
    socket.publish(channelname,prot);
  } catch(err) {
    console.log('exception socket cluster client '+err)
  }


}


