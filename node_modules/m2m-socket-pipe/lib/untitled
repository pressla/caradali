//m2m-socket-pipe.js
//Alex Pressl for imitrix GmbH
//use:
// var m2m = require('m2m-socket-pipe');
// m2m.log ('lightcontrol', 'cmd', {cmd:'Lamp 100%', err:'no answer'});

// will send following socket cluster post to channel 'lightcontrol':
/*
[
  {
    "timestamp": "1427496743",
    "node_id": "c6:93:00:02:18:d8",
    "content": "cmd"
  },
  {
    "cmd": "Lamp 100%",
    "err": "no answer"
   }
]
*/


var scClient 	= require('socketcluster-client');
var wrt			= require('wrt');
var exec		= require('child_process').exec;

var options = {
  protocol: 'http',
  hostname: 'acc.ledwifi.de',
  port: 8051,
  autoReconnect: true
};
 
var socket = scClient.connect(options);
 
var header 		= {};
var prot 		= [2];



module.export = log = function(channelname, messagename, payload){

	var ifconfig 	= wrt.ifconfig();

	header.timestamp 	= (new Date().getTime()/1000).toFixed(0);
	header.node_id 		= ifconfig.apif[1].MAC;
	header.content 		= messagename;

	prot[0] = header;
	prot[1] = ifconfig;
	socket.publish(channelname,prot);

}


