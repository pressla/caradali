//subscriber.js
//listening to udp multicast messages


var Dgram = require('dgram');
var Emitter = require('events').EventEmitter;
var Relay = new Emitter();
var sub = Dgram.createSocket('udp4');


var internals = {
	initialized:false,
	multicastID: '239.1.1.200',
	targetPort:  61088
};


	sub.bind(internals.targetPort, function () {
    	sub.addMembership(internals.multicastID);     //listen to this group  
    	console.log('server registered to listen to multicast ip: '+internals.multicastID);
	});

	sub.on('listening', function () {
    	var address = sub.address();
    	//myApp.logger.log('info',address);
    	console.log('UDP listening ' + address.address + ":" + address.port);
	});

	sub.on('message', function (buf, rinfo) {
    	var buff = new Buffer(buf).toString('ascii');
    	var obj = buff.split(',');
    	obj.push(rinfo);
    	console.log('debug',JSON.stringify(obj));
    	Relay.emit(obj[0], obj);    //Fire the event for each command
	});